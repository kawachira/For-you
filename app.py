import streamlit as st
from tvDatafeed import TvDatafeed, Interval
import pandas as pd
import pandas_ta as ta

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="TradingView AI", page_icon="üìâ", layout="wide")
st.title("üìâ TradingView AI: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏∏‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏á‡πâ‡∏≠ Yahoo")

# --- 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (Anonymous Mode) ---
# ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô (‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡πâ‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)
tv = TvDatafeed()

# --- 3. Sidebar ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ---
with st.sidebar:
    st.header("üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏∏‡πâ‡∏ô (TradingView)")
    
    # ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏•‡∏≤‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
    exchange = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏•‡∏≤‡∏î (Exchange):", 
        ["NASDAQ (‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏ó‡∏Ñ‡∏™‡∏´‡∏£‡∏±‡∏ê)", "NYSE (‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏™‡∏´‡∏£‡∏±‡∏ê)", "SET (‡∏´‡∏∏‡πâ‡∏ô‡πÑ‡∏ó‡∏¢)", "CRYPTO (‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)"], 
        index=0
    )
    
    # ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    exch_map = {
        "NASDAQ (‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏ó‡∏Ñ‡∏™‡∏´‡∏£‡∏±‡∏ê)": "NASDAQ",
        "NYSE (‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏™‡∏´‡∏£‡∏±‡∏ê)": "NYSE",
        "SET (‡∏´‡∏∏‡πâ‡∏ô‡πÑ‡∏ó‡∏¢)": "SET",
        "CRYPTO (‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)": "BINANCE"
    }
    selected_exchange = exch_map[exchange]
    
    symbol = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ .BK):", value="EOSE").upper().strip()
    
    st.info(f"üí° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: **{symbol}** ‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î **{selected_exchange}**")
    
    run_btn = st.button("üöÄ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏•‡∏¢")

# --- 4. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---
if run_btn:
    with st.spinner(f"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å TradingView..."):
        try:
            # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 500 ‡πÅ‡∏ó‡πà‡∏á)
            df = tv.get_hist(symbol=symbol, exchange=selected_exchange, interval=Interval.in_daily, n_bars=500)
            
            if df is None or df.empty:
                st.error(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏∏‡πâ‡∏ô **{symbol}** ‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î **{selected_exchange}**")
                st.warning("‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:\n1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô\n2. ‡∏ó‡πà‡∏≤‡∏ô‡∏≠‡∏≤‡∏à‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏ï‡∏•‡∏≤‡∏î' ‡∏ú‡∏¥‡∏î (‡πÄ‡∏ä‡πà‡∏ô EOSE ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å NASDAQ, PTT ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å SET)")
            else:
                # --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
                # tvDatafeed ‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏õ‡∏•‡∏Å‡πÜ ‡πÄ‡∏ä‡πà‡∏ô 'symbol:close' ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠
                df.columns = [col.split(":")[-1] for col in df.columns] # ‡∏ï‡∏±‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏¥‡πâ‡∏á ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà close, open
                df.columns = [col.capitalize() for col in df.columns]   # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Close, Open
                
                # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Indicator
                df['EMA200'] = ta.ema(df['Close'], length=200)
                df['RSI'] = ta.rsi(df['Close'], length=14)
                
                last = df.iloc[-1]
                price = last['Close']
                
                # --- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
                c1, c2 = st.columns(2)
                c1.metric("‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î", f"{price:.2f}")
                c2.metric("RSI", f"{last['RSI']:.2f}")
                
                # ‡∏Å‡∏£‡∏≤‡∏ü
                st.line_chart(df['Close'])
                
                # Logic ‡∏á‡πà‡∏≤‡∏¢‡πÜ
                if pd.notna(last['EMA200']):
                    if price > last['EMA200']:
                        st.success(f"‚úÖ ‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô (‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡πÄ‡∏™‡πâ‡∏ô 200 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {last['EMA200']:.2f})")
                    else:
                        st.error(f"üîª ‡∏Ç‡∏≤‡∏•‡∏á (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏™‡πâ‡∏ô 200 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {last['EMA200']:.2f})")
                
                # ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö
                with st.expander("‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å TradingView"):
                    st.dataframe(df.tail())

        except Exception as e:
            st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
            st.write("‡∏ñ‡πâ‡∏≤ Error ‡∏ß‡πà‡∏≤ 'NoneType', ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö")
